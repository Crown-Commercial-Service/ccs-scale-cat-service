package uk.gov.crowncommercial.dts.scale.cat.service;

import static java.time.Duration.ofSeconds;
import static java.util.Optional.ofNullable;
import static org.springframework.http.HttpStatus.INTERNAL_SERVER_ERROR;
import static uk.gov.crowncommercial.dts.scale.cat.config.AgreementsServiceAPIConfig.KEY_URI_TEMPLATE;
import java.util.List;
import java.util.stream.Collectors;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import uk.gov.crowncommercial.dts.scale.cat.config.AgreementsServiceAPIConfig;
import uk.gov.crowncommercial.dts.scale.cat.exception.JaggaerApplicationException;
import uk.gov.crowncommercial.dts.scale.cat.model.agreements.DataTemplate;
import uk.gov.crowncommercial.dts.scale.cat.model.agreements.TemplateCriteria;
import uk.gov.crowncommercial.dts.scale.cat.model.generated.EventType;

/**
 *
 */
@Service
@RequiredArgsConstructor
public class AgreementsService {

  public static void main(final String[] args) throws Exception {
    final var json =
        "[[{\"id\":\"Criterion 1\",\"title\":\"Technical Envelope\",\"description\":\"Information You are looking for\",\"source\":\"buyer\",\"relatesTo\":\"tenderer\",\"relateItems\":null,\"requirementGroups\":[{\"nonOCDS\":{\"prompt\":\"Specify each question you are requesting an answer to.\",\"task\":\"Add Information you are looking for\",\"mandatory\":true},\"OCDS\":{\"id\":\"Group 1\",\"description\":\"Information You are looking for\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":true,\"options\":null},\"OCDS\":{\"id\":\"Question 1\",\"title\":\"Enter Your First Question\",\"description\":\"Add Another Question\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}}]}}]},{\"id\":\"Criterion 2\",\"title\":\"Buyer Details\",\"description\":\"For Information Only\",\"source\":\"buyer\",\"relatesTo\":\"buyer\",\"relateItems\":null,\"requirementGroups\":[{\"nonOCDS\":{\"prompt\":\"Tell us on whose behalf you will be inviting tenders?\",\"task\":\"Add Buyer Details\",\"mandatory\":true},\"OCDS\":{\"id\":\"Group 2\",\"description\":\"Who is the buyer\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 2\",\"title\":\"Name of the Contracting Authority\",\"description\":\"Who is running the procurement\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":false,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 3\",\"title\":\"Name of contracting authority you are buying on behalf of\",\"description\":\"If different from contracting authority\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null}}]}},{\"nonOCDS\":{\"prompt\":\"Select the required level of national security vetting required for this project.\",\"task\":\"Add security and vetting requirements\",\"mandatory\":true},\"OCDS\":{\"id\":\"Group 3\",\"description\":\"Security and Vetting requirements\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"SingleSelect\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":[{\"value\":\"Baseline Personnel Security Standard (BPSS)\",\"select\":false},{\"value\":\"Counter Terrorist Check (CTC)\",\"select\":false},{\"value\":\"Security Check (SC)\",\"select\":false},{\"value\":\"Enhanced Security Check (eSC)\",\"select\":false},{\"value\":\"Developed Vetting (DV)\",\"select\":false},{\"value\":\"Renewal and Enhanced Developed Vetting (eDV)\",\"select\":false}]},\"OCDS\":{\"id\":\"Question 4\",\"title\":\"Select the required level of national security vetting required for this project.\",\"description\":\"Select the required level of national security vetting required for this project.\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}}]}},{\"nonOCDS\":{\"prompt\":\"Include a definition of key terms and acrynoms used in your Rfi\",\"task\":\"Add term and acronyms\",\"mandatory\":true},\"OCDS\":{\"id\":\"Group 4\",\"description\":\"Key Terms and acronyms\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"KeyValuePair\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":true,\"options\":null},\"OCDS\":{\"id\":\"Question 5\",\"title\":\"Term or Acronym\",\"description\":\"Add another\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}}]}},{\"nonOCDS\":{\"prompt\":\"Include a definition of key terms and acrynoms used in your Rfi\",\"task\":\"Add address\",\"mandatory\":true},\"OCDS\":{\"id\":\"Group 5\",\"description\":\"Where the work will be completed\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"Address\",\"answered\":false,\"mandatory\":false,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 6\",\"title\":\"Where will the work be completed\",\"description\":\"Add another\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}}]}},{\"nonOCDS\":{\"prompt\":\"You can specify your (indicator) budget range, your maximum budget, and, or your maximum rate per day in the next step.\",\"mandatory\":true,\"task\":\"Add budget\"},\"OCDS\":{\"id\":\"Group 6\",\"description\":\"Specify your budget\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 7\",\"title\":\"Maximum indicative budget\",\"description\":\"\",\"dataType\":\"string\",\"pattern\":\"/^£?(([1-9]{1,3}(,\\\\d{3})*(\\\\.\\\\d{2})?)|(0\\\\.[1-9]\\\\d)|(0\\\\.0[1-9]))$/\",\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":false,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 8\",\"title\":\"Minimum indicative budget\",\"description\":\"\",\"dataType\":\"string\",\"pattern\":\"/^£?(([1-9]{1,3}(,\\\\d{3})*(\\\\.\\\\d{2})?)|(0\\\\.[1-9]\\\\d)|(0\\\\.0[1-9]))$/\",\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}}]}},{\"nonOCDS\":{\"prompt\":\"You can specify here your maximum rate per day.\",\"task\":\"Add daily rate\",\"mandatory\":true},\"OCDS\":{\"id\":\"Group 7\",\"description\":\"Specify your daily rate\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 9\",\"title\":\"Maximum rate per day\",\"description\":\"\",\"dataType\":\"string\",\"pattern\":\"/^£?(([1-9]{1,3}(,\\\\d{3})*(\\\\.\\\\d{2})?)|(0\\\\.[1-9]\\\\d)|(0\\\\.0[1-9]))$/\",\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"SingleSelect\",\"answered\":false,\"mandatory\":false,\"multiAnswer\":false,\"options\":[{\"value\":\"per individual\",\"select\":false},{\"value\":\"in aggregate\",\"select\":false}]},\"OCDS\":{\"id\":\"Question 10\",\"title\":\"Minimum indicative budget\",\"description\":\"\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}}]}},{\"nonOCDS\":{\"prompt\":\"Provide some details about your project.\",\"task\":\"Add information about the project\",\"mandatory\":true},\"OCDS\":{\"id\":\"Group 8\",\"description\":\"About the project\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 11\",\"title\":\"What is the Project / Programme Name?\",\"description\":\"\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":false,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 12\",\"title\":\"What is your procurement reference\",\"description\":\"\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 13\",\"title\":\"Why is this work required?\",\"description\":\"State why this work is required to help suppliers frame the project\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 14\",\"title\":\"Set out the problem statement for the Project / Programme\",\"description\":\"This will help suppliers to identify how they can help you with your project\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 15\",\"title\":\"What resource will work on\",\"description\":\"Describe the aspects of the project and / or technologies that the resource will work on\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 16\",\"title\":\"Key users\",\"description\":\"List the key users of the project deliverables\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 17\",\"title\":\"Key outcomes\",\"description\":\"What are the required outcomes for the key users?\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}}]}},{\"nonOCDS\":{\"prompt\":\"Provide some details about the status of your project.\",\"task\":\"Add status of the project\",\"mandatory\":true},\"OCDS\":{\"id\":\"Group 9\",\"description\":\"Status of your project\",\"requirements\":[{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 18\",\"title\":\"Indicate the phase the resource will be engaged for\",\"description\":\"\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":false,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 19\",\"title\":\"Set out the detail of work previously completed\",\"description\":\"Outline any work that has already been carried out on the project\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 20\",\"title\":\"Market engagement to date\",\"description\":\"Outline any market engagement that has already been carried out in relation to this procurement\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":true,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 21\",\"title\":\"Working arrangements\",\"description\":\"Specify the working arrangements that the resource will adhere to\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}},{\"nonOCDS\":{\"questionType\":\"Value\",\"answered\":false,\"mandatory\":false,\"multiAnswer\":false,\"options\":null},\"OCDS\":{\"id\":\"Question 22\",\"title\":\"Existing team (optional)\",\"description\":\"Detail whom the specialist will work with\",\"dataType\":\"string\",\"pattern\":null,\"expectedValue\":null,\"minValue\":null,\"maxValue\":null,\"period\":null}}]}}]}]]";
    final var oj =
        new ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);

    final var dataTemplates =
        oj.readValue(json, new TypeReference<List<List<TemplateCriteria>>>() {});
  }

  private final WebClient agreementsServiceWebClient;

  private final AgreementsServiceAPIConfig agreementServiceAPIConfig;

  public List<DataTemplate> getLotEventTypeDataTemplates(final String agreementId,
      final String lotId, final EventType eventType) {

    final var getLotEventTypeDataTemplatesUri =
        agreementServiceAPIConfig.getGetLotEventTypeDataTemplates().get(KEY_URI_TEMPLATE);

    final ParameterizedTypeReference<List<List<TemplateCriteria>>> typeRefTemplateCriteria =
        new ParameterizedTypeReference<>() {};

    final var dataTemplates = ofNullable(agreementsServiceWebClient.get()
        .uri(getLotEventTypeDataTemplatesUri, agreementId, lotId, eventType.getValue()).retrieve()
        .bodyToMono(typeRefTemplateCriteria)
        .block(ofSeconds(agreementServiceAPIConfig.getTimeoutDuration())))
            .orElseThrow(() -> new JaggaerApplicationException(INTERNAL_SERVER_ERROR.value(),
                "Unexpected error retrieving RFI template from AS"));

    return dataTemplates.stream().map(tcs -> DataTemplate.builder().criteria(tcs).build())
        .collect(Collectors.toList());
  }

}
